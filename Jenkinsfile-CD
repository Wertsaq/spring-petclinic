stage('Health Check') {
    steps {
        script {
            echo 'Waiting for the application to start...'

            def serverCredentials = getServerCredentials(params.ENVIRONMENT) 

            def maxRetries = 10
            def retryInterval = 15  
            def initialDelay = 15  
            def healthCheckUrl

            withCredentials([
                string(credentialsId: serverCredentials.serverId, variable: 'SERVER_ADDRESS'),
                string(credentialsId: serverCredentials.portId, variable: 'PORT')
            ]) {
                healthCheckUrl = "http://${SERVER_ADDRESS}:${PORT}/actuator/health"
            }

            echo "Performing health check on ${healthCheckUrl}..."

            sleep(time: initialDelay, unit: 'SECONDS')

            def healthCheckPassed = false

            for (int i = 0; i < maxRetries; i++) {
                def statusCode = sh(
                    script: "curl -o /dev/null -s -w \"%{http_code}\" ${healthCheckUrl}",
                    returnStdout: true
                ).trim()

                if (statusCode == '200') {
                    echo "Health check passed with status code 200!"
                    healthCheckPassed = true
                    break
                } else {
                    echo "Health check attempt ${i+1}/${maxRetries} failed with status code ${statusCode}. Retrying in ${retryInterval} seconds..."
                    sleep(time: retryInterval, unit: 'SECONDS')
                }
            }

            if (!healthCheckPassed) {
                echo "Health check failed after ${maxRetries} attempts."
                error("Health check failed")
            }
        }
    }
}
