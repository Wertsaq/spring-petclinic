pipeline {
    agent { label 'jenkins-slave-docker-petclinic' }

    options {
        skipDefaultCheckout()
    }

    environment {
        IMAGE_NAME = 'wertsaq/petclinic'
    }

    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'qa'], description: 'Select the deployment environment')
        choice(name: 'IMAGE_TAG', choices: ['3.3.0', 'latest'], description: 'Docker image tag to deploy')
    }

    stages {
        stage('Deploy') {
            steps {
                script {
                    echo "Deploying application to ${params.ENVIRONMENT} environment with tag ${params.IMAGE_TAG}..."

                    def (serverId, portId) = getServerCredentials(params.ENVIRONMENT)

                    sh "docker stop petclinic || true",
                    sh "docker rm petclinic || true",
                    sh "docker pull ${IMAGE_NAME}:${params.IMAGE_TAG}",
                    sh "docker run -d --name petclinic -p ${PORT}:8080 ${IMAGE_NAME}:${params.IMAGE_TAG}"
                }
            }
        }
    }
}

def getServerCredentials(environment) {
    switch (environment) {
        case 'dev':
            return ['dev-server-address', 'dev-port']
        case 'qa':
            return ['qa-server-address', 'qa-port']
        default:
            error("Unknown environment: ${environment}")
    }
}
