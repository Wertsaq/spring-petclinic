pipeline {
    agent { label 'jenkins-slave-docker-petclinic' }

    options {
        skipDefaultCheckout()
    }

    environment {
        IMAGE_NAME = 'wertsaq/petclinic'
    }

    parameters {
        choice(name: 'ENVIRONMENT', choices: ['dev', 'qa'], description: 'Select the deployment environment')
        choice(name: 'IMAGE_TAG', choices: getDockerTags('wertsaq/petclinic'), description: 'Docker image tag to deploy')
    }

    stages {
        stage('Deploy') {
            steps {
                script {
                    echo "Deploying application to ${params.ENVIRONMENT} environment with tag ${params.IMAGE_TAG}..."

                    def credentials = getServerCredentials(params.ENVIRONMENT)
                    env.SERVER_ADDRESS = credentials.serverId
                    env.PORT = credentials.portId

                    sshagent(['ssh-deploy-prod-server']) {
                        sh "ssh -o StrictHostKeyChecking=no ubuntu@${SERVER_ADDRESS} 'docker stop petclinic || true'"
                        sh "ssh -o StrictHostKeyChecking=no ubuntu@${SERVER_ADDRESS} 'docker rm petclinic || true'"
                        sh "ssh -o StrictHostKeyChecking=no ubuntu@${SERVER_ADDRESS} 'docker pull ${IMAGE_NAME}:${params.IMAGE_TAG}'"
                        sh "ssh -o StrictHostKeyChecking=no ubuntu@${SERVER_ADDRESS} 'docker run -d --name petclinic -p ${PORT}:8080 ${IMAGE_NAME}:${params.IMAGE_TAG}'"
                    }
                }
            }
        }
    }
}

def getServerCredentials(environment) {
    def serverCredentialsId = ''
    def portCredentialsId = ''

    switch (environment) {
        case 'dev':
            serverCredentialsId = 'dev-server-address'
            portCredentialsId = 'dev-port'
            break;
        case 'qa':
            serverCredentialsId = 'qa-server-address'
            portCredentialsId = 'qa-port'
            break;
        default:
            error("Unknown environment: ${environment}")
    }

    return [serverId: serverCredentialsId, portId: portCredentialsId]
}

def getDockerTags(imageName) {
    node(jenkins-slave-docker-petclinic) {
        withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
            def token = sh(script: "curl -s -H \"Content-Type: application/json\" -X POST -d '{\"username\": \"${DOCKER_USERNAME}\", \"password\": \"${DOCKER_PASSWORD}\"}' https://hub.docker.com/v2/users/login/ | jq -r .token", returnStdout: true).trim()
            
            def response = sh(script: "curl -s -H \"Authorization: JWT ${token}\" https://hub.docker.com/v2/repositories/${imageName}/tags/?page_size=100", returnStdout: true).trim()
            def json = readJSON text: response
            def tags = json.results.collect { it.name }
            
            return tags.isEmpty() ? ['latest'] : tags
        }
    }
}
